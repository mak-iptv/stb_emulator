<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IPTV M3U Player — Single File</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#06b6d4}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#071028 0%, #071222 100%);color:#e6eef6}
    .app{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;gap:16px;align-items:center}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    input[type=text]{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;min-width:320px}
    button{padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:#032;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    main{display:grid;grid-template-columns:420px 1fr;gap:16px;margin-top:18px}
    .left{background:var(--card);padding:12px;border-radius:12px}
    .player{background:#000;border-radius:8px;overflow:hidden}
    video{width:100%;height:360px;display:block;background:#000}
    .list{margin-top:12px}
    .ch{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
    .ch:hover{background:rgba(255,255,255,0.02)}
    .ch img{width:56px;height:34px;object-fit:cover;border-radius:4px}
    .meta{flex:1}
    .meta b{display:block}
    .search{margin-top:8px}
    .foot{margin-top:10px;font-size:13px;color:var(--muted)}
    .big-controls{display:flex;gap:8px;margin-top:8px}
    .kbd{background:#081226;padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);font-size:13px}
    @media(max-width:900px){main{grid-template-columns:1fr}video{height:220px}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>IPTV M3U Player — HTML/CSS/JS (single file)</h1>
    </header>

    <div class="controls">
      <label style="display:flex;align-items:center;gap:6px;font-size:13px;color:var(--muted)">
        <input type="checkbox" id="useProxy"> Përdor CORS proxy
      </label>
      <input id="m3uUrl" type="text" placeholder="Ngjit URL e playlist M3U (ose HLS .m3u8) këtu..." />
      <button id="loadUrl">Ngarko nga URL</button>
      <label class="ghost" style="display:inline-block;padding:10px 12px;border-radius:8px;cursor:pointer">
        Ngarko skedarin M3U
        <input id="fileInput" type="file" accept=".m3u,.txt" style="display:none">
      </label>
      <button id="clear" class="ghost">Pastro</button>
    </div>

    <main>
      <section class="left">
        <div class="player">
          <video id="video" controls playsinline></video>
        </div>
        <div class="big-controls">
          <button id="playPause">Play/Pause</button>
          <button id="volDown" class="ghost">Vol -</button>
          <button id="volUp" class="ghost">Vol +</button>
          <button id="pip" class="ghost">PIP</button>
        </div>
        <div class="foot">
          <div>Kontrollet: <span class="kbd">Space</span> play/pause, <span class="kbd">/</span> fokuso kërkimin, <span class="kbd">ArrowUp/Down</span> volume</div>
        </div>
      </section>

      <section class="right">
        <div style="background:var(--card);padding:12px;border-radius:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Lista e kanaleve</strong>
            <input id="filter" class="search" placeholder="Filtro: kërko emrin..." />
          </div>
          <div id="list" class="list"></div>
        </div>
      </section>
    </main>

    <div style="max-width:1100px;margin-top:12px;color:var(--muted);font-size:13px">
      <p>Shënim: Nëse URL-ja e playlist vjen nga tjetër domain, serveri duhet të lejojë CORS. Për STB native (Linux/Android) ky faqe mund të përdoret si wrapper ose t'i paketoni si Electron/Chromium app për Mac/PC. Mos përdorni për materiale të paligjshme.</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    // Simple M3U parser (handles basic #EXTINF and tvg-logo attributes)
    function parseM3U(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const items = [];
      let i = 0;
      while(i < lines.length){
        const line = lines[i];
        if(line.startsWith('#EXTINF')){
          const info = line.substring(8);
          // try to extract tvg-logo and name
          const attrs = {};
          const attrRegex = /(\w+?)="([^"]*)"/g;
          let m;
          while((m = attrRegex.exec(info)) !== null){ attrs[m[1]] = m[2]; }
          const commaIndex = info.indexOf(',');
          const name = commaIndex !== -1 ? info.substring(commaIndex+1).trim() : info;
          const next = lines[i+1] || '';
          items.push({name,logo:attrs['tvg-logo']||attrs['logo']||'',url:next});
          i += 2;
        } else if(!line.startsWith('#')){
          // bare URL line -> make an item if previous wasn't EXTINF
          items.push({name:line,logo:'',url:line});
          i++;
        } else {
          i++;
        }
      }
      return items;
    }

    const listEl = document.getElementById('list');
    const video = document.getElementById('video');
    const m3uUrl = document.getElementById('m3uUrl');
    const filter = document.getElementById('filter');
    let items = [];
    let currentIndex = -1;

    function renderList(filterText=''){
      listEl.innerHTML = '';
      const filtered = items.filter(it => it.name.toLowerCase().includes(filterText.toLowerCase()));
      filtered.forEach((it, idx) =>{
        const row = document.createElement('div'); row.className='ch';
        const img = document.createElement('img'); img.src = it.logo || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="72"><rect width="100%" height="100%" fill="#15202b"/></svg>';
        const meta = document.createElement('div'); meta.className='meta';
        meta.innerHTML = `<b>${escapeHtml(it.name)}</b><small style="color:var(--muted)">${it.url}</small>`;
        row.appendChild(img); row.appendChild(meta);
        row.addEventListener('click', ()=> playItem(it));
        listEl.appendChild(row);
      });
    }

    function escapeHtml(s){ return s.replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]||c)); }

    async function loadFromUrl(url){
      const useProxy = document.getElementById('useProxy').checked;
      const finalUrl = useProxy ? `https://cors-proxy.odyssey.workers.dev/?${encodeURIComponent(url)}` : url;
      try{
        const res = await fetch(finalUrl);(url){
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error('Network error '+res.status);
        const text = await res.text();
        items = parseM3U(text);
        renderList();
        if(items.length) playItem(items[0]);
      }catch(err){ alert('Gabim: '+err.message + '
(Zgjidhja: aktivizo opsionin “Përdor CORS proxy” nëse serveri bllokon CORS) + '\n(Vini re: CORS mund të bllokojë fetch nga shfletuesi)'); }
    }

    function loadFromFile(file){
      const reader = new FileReader();
      reader.onload = e => {
        items = parseM3U(e.target.result);
        renderList();
        if(items.length) playItem(items[0]);
      };
      reader.readAsText(file);
    }

    function playItem(it){
      const src = it.url;
      currentIndex = items.indexOf(it);
      // handle HLS (.m3u8) via hls.js or native
      if(src && src.indexOf('.m3u8') !== -1){
        if(Hls.isSupported()){
          if(window._hls) { window._hls.destroy(); window._hls = null; }
          const hls = new Hls(); window._hls = hls;
          hls.loadSource(src);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, function(){ video.play(); });
        } else {
          video.src = src; video.play().catch(()=>{});
        }
      } else {
        // try set as source; many IPTV streams are MPEG-TS over HTTP and may not play in browser
        video.src = src; video.play().catch(()=>{ alert('Përmbajtja nuk mund të luhet direkt në shfletues. Disa URL kërkojnë një player të jashtëm ose shërbim transcoding.'); });
      }
    }

    // UI hooks
    document.getElementById('loadUrl').addEventListener('click', ()=>{
      const url = m3uUrl.value.trim(); if(!url) return alert('Vendosni URL'); loadFromUrl(url);
    });
    document.getElementById('fileInput').addEventListener('change', e => {
      const f = e.target.files[0]; if(!f) return; loadFromFile(f);
    });
    document.getElementById('clear').addEventListener('click', ()=>{ items=[]; listEl.innerHTML=''; video.pause(); video.removeAttribute('src'); video.load(); });

    document.getElementById('playPause').addEventListener('click', ()=> video.paused ? video.play() : video.pause());
    document.getElementById('volUp').addEventListener('click', ()=> video.volume = Math.min(1, video.volume + 0.1));
    document.getElementById('volDown').addEventListener('click', ()=> video.volume = Math.max(0, video.volume - 0.1));
    document.getElementById('pip').addEventListener('click', async ()=>{ if(document.pictureInPictureElement){ await document.exitPictureInPicture(); } else { try{ await video.requestPictureInPicture(); }catch(e){ alert('PIP nuk mbështetet: '+e.message); } } });

    filter.addEventListener('input', ()=> renderList(filter.value));

    // keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(e.code === 'Space' && document.activeElement.tagName !== 'INPUT') { e.preventDefault(); video.paused ? video.play() : video.pause(); }
      if(e.key === '/') { e.preventDefault(); filter.focus(); }
      if(e.key === 'ArrowUp') { e.preventDefault(); video.volume = Math.min(1, video.volume + 0.05); }
      if(e.key === 'ArrowDown') { e.preventDefault(); video.volume = Math.max(0, video.volume - 0.05); }
    });

    // small helper: try to load example if none
    // (commented out) 
    // loadFromUrl('https://example.com/playlist.m3u');
  </script>
</body>
</html>
