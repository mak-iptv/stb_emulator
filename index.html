<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="UTF-8" />
<title>IPTV Player (TS + M3U8)</title>
<style>
  body {margin:0;background:#000;font-family:Arial;color:white;display:flex;height:100vh;}
  #sidebar {width:320px;background:#111;overflow-y:auto;border-right:2px solid #222;padding:10px;}
  #player {flex:1;display:flex;flex-direction:column;}
  video {width:100%;height:100%;background:#000;}
  .item {padding:8px;background:#222;margin-bottom:6px;border-radius:6px;cursor:pointer;}
  .item:hover {background:#444;}
  input{width:100%;padding:5px;border-radius:5px;border:1px solid #333;background:#111;color:white;margin-bottom:10px;}
</style>
</head>
<body>

<div id="sidebar">
  <input id="m3uUrl" placeholder="Vendos URL të M3U" />
  <button onclick="loadM3U()">Ngarko</button>
  <div id="channels"></div>
</div>

<div id="player">
  <video id="vid" controls autoplay></video>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
let list = [];

async function fetchURL(url) {
  try {
    return await fetch(url);
  } catch (e) {
    return await fetch("https://cors-proxy.odyssey.workers.dev/?" + encodeURIComponent(url));
  }
}

async function loadM3U() {
  const url = document.getElementById("m3uUrl").value.trim();
  if (!url) return;

  const res = await fetchURL(url);
  const text = await res.text();

  list = parseM3U(text);
  render();
}

function parseM3U(text) {
  const lines = text.split(/\r?\n/);
  let ch = [];
  let name = "";
  for (let i=0;i<lines.length;i++){
    if (lines[i].startsWith("#EXTINF")){
      const m = lines[i].match(/,(.*)$/);
      name = m ? m[1] : "Pa emër";
    } else if (lines[i].startsWith("http")){
      ch.push({name, url:lines[i]});
    }
  }
  return ch;
}

function render() {
  const box = document.getElementById("channels");
  box.innerHTML = "";
  list.forEach((c,i)=>{
    const div = document.createElement("div");
    div.className = "item";
    div.textContent = c.name;
    div.onclick = ()=> play(c.url);
    box.appendChild(div);
  });
}

function play(url) {
  const video = document.getElementById("vid");

  // LUAN M3U8 ME HLS.JS
  if (url.endsWith(".m3u8")) {
    if (Hls.isSupported()){
      video.src = "";
      const hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
      return;
    } else {
      video.src = url;
      return;
    }
  }

  // LUAN .TS (DIRECT TS)
  if (url.endsWith(".ts")) {
    // Shumica e shfletuesve nuk e luajnë TS direkt → përdorim MediaSource
    try {
      playTS(url);
    } catch (e) {
      alert("TS nuk u luajt. Duhet .m3u8 ose server transkodimi.");
    }
    return;
  }

  // default
  video.src = url;
}

// PROVIMI ME MediaSource PËR TS
async function playTS(url){
  const video = document.getElementById("vid");
  const ms = new MediaSource();
  video.src = URL.createObjectURL(ms);

  ms.addEventListener("sourceopen", async ()=>{
    const sb = ms.addSourceBuffer('video/mp2t; codecs="avc1.4d401e, mp4a.40.2"');
    const r = await fetchURL(url);
    const data = await r.arrayBuffer();
    sb.appendBuffer(data);
  });
}
</script>

</body>
</html>
